define(["util/doT","util/ajax","util/select","util/alert","util/share","text!template/form_item/checkbox.html!strip","text!template/form_item/input.html!strip","text!template/form_item/line.html!strip","text!template/form_item/radio.html!strip","text!template/form_item/select.html!strip","text!template/form_item/textarea.html!strip","text!template/form_item/item_list.html!strip","text!template/form_item/image.html!strip","text!template/form_item/picture.html!strip","text!template/form_setting/checkbox.html!strip","text!template/form_setting/line.html!strip","text!template/form_setting/select.html!strip","text!template/form_setting/text.html!strip","text!template/form_setting/select_item.html!strip","text!template/form_setting/select_del_item.html!strip","text!template/form_setting/search_page.html!strip","text!template/form_setting/image.html!strip","text!template/form_setting/picture.html!strip","text!template/form_setting/picture_del_item.html!strip","text!template/form_setting/picture_item.html!strip","text!template/sidebar.html!strip","text!template/form_edit.html!strip","text!template/complate.html!strip","text!template/form_answers.html!strip","text!template/answers/answer.html!strip","text!template/answers/answers.html!strip!","text!template/answers/text.html!strip","text!template/answers/share.html!strip","text!template/table/table.html!strip","text!template/pageNav.html!strip"],function(t,e,a,i,n,r,o,d,s,c,f,l,p,u,m,h,v,g,_,x,y,w,k,b,C,z,I,S,q,N,W,M,T,D,H){function J(){Mt=t.template(r),Tt=t.template(o),Dt=t.template(d),Ht=t.template(s),Jt=t.template(c),Ot=t.template(f),At=t.template(l),Pt=t.template(p),Bt=t.template(u),jt=t.template(m),Yt=t.template(h),Ft=t.template(v),Lt=t.template(g),Zt=t.template(_),Kt=t.template(x),Gt=t.template(w),Qt=t.template(k),Rt=t.template(b),Ut=t.template(C),Vt=t.template(z),ee=t.template(I),te=t.template(S),Xt=t.template(q),ae=t.template(N),ie=t.template(W),oe=t.template(D),re=t.template(M),de=t.template(H),Et=t.template(y),ne=t.template(T),O(),j(),qt()}function O(){ue.empty(),$.getJSON("/pa/survey/surveys?site_id="+he,{page_size:100,page_no:1},function(t){var e=t.data.dataList;ue.append(Vt(e))})}function A(t,e){$.getJSON("/pageui/ajax-page-publish-list?site_id="+he,function(a){if(a.data.items.length<1){var i='<div class="f-mold f-header-opt"><div class="f-header red">您还没有发布页面，请先 <a href="/pageui/?site_id='+he+'">发布页面</a></div></div>';me.empty(),me.append(i)}else{if(me.empty(),t)t.KZpages=a.data.items,me.append(ee(t)),e();else{var n={};n.KZpages=a.data.items,n.title="请输入表单标题",n.subtitle="请输入表单副标题",me.append(ee(n))}B(),Y()}})}function P(){$("#f_select_opt").on("click",'[data-type="select-page"]',function(){$("#f_selectpage").show(),$("#f_selectdoc").hide()}).on("click",'[data-type="select-doc"]',function(){$("#f_selectpage").hide(),$("#f_selectdoc").show()});var t=$(".f-search-doc");t.on("keyup",'[data-action="show-doc-list"]',function(){var e=$('[data-action="show-doc-list"]').val();return""==e?($(".f-search-list")[0]&&$(".f-search-list").remove(),$('[data-action="show-doc-list"]').attr("data-docId",""),!1):void $.getJSON("/post/ajax-search-post?site_id="+he+"&q="+e,function(e){$(".f-search-list").remove(),e.data.count>0&&t.append(Et(e.data))})}).on("click",'[data-action="seach-item"]',function(){var t=$(this).attr("data-docId");$('[data-action="show-doc-list"]').val($(this).text()),$('[data-action="show-doc-list"]').attr("data-docId",t),$(".f-search-list").remove()})}function B(){le=$(".f-form-view-bg",me);var t=$(window).height()-$("header").outerHeight()-$(".f-b-nav").outerHeight()-$(".f-btn-wrap").outerHeight()-100;le.height(t)}function j(){$t(),It()}function Y(){lt(),Z(),V(),Q(),R(),et(),F(),at(),P(),K()}function F(){var t=$(".f-form-edit-btn",me),e=$(".f-clip-wrap",me),a=0;t.on("click",'[data-action="next"]',function(){e.animate({"margin-left":a-920},300,function(){a-=920})}).on("click",'[data-action="pre"]',function(){e.animate({"margin-left":a+920},300,function(){a+=920})}).on("click",'[data-action="creat"]',function(){ot()}).on("click",'[data-action="publish"]',function(){dt()})}function L(t){ce=$(".f-form-setting"),fe=$(".f-form-item-list"),ce.empty(),fe.find('[current="true"]').removeAttr("current")}function Z(){se=$(".f-add-section",me),ce=$(".f-form-setting",me);var t={};t.title="默认标题",t.placeholder="默认文本",t.value=[{name:"默认选项"}],t.type="text",t["default"]="默认选项",t.required=1,t.description="",t.descriptions="输入对图片的相关描述",t.url="http://www.kuaizhan.com/",se.on("click",'[data-action="add-input"]',function(){L(),ce.append(Lt(t)),se.before(Tt(t)),G(),pe=!1}).on("click",'[data-action="add-checkbox"]',function(){L(),ce.append(jt(t)),se.before(Mt(t)),G(),pe=!1}).on("click",'[data-action="add-select"]',function(){L(),ce.append(Ft(t)),se.before(Jt(t)),G(),pe=!1}).on("click",'[data-action="add-line"]',function(){L(),ce.append(Yt(t)),se.before(Dt(t)),G(),pe=!1}).on("click",'[data-action="add-image"]',function(){L(),ce.append(Gt(t)),se.before(Pt(t)),G(),pe=!1}).on("click",'[data-action="add-picture"]',function(){L(),ce.append(Qt(t)),se.before(Bt(t)),G(),pe=!1})}function K(){$("#form_title_ipt").find("input").on("keyup focusout",function(){E(this,15)}),$("#form_subtitle_ipt").find(".f-textarea").on("keyup focusout",function(){E(this,100)})}function E(t,e){var a=$(t),i=a.closest(".f-control-group").find(".f-control-tips").find("span");i.text(a.val().length),a.val().length>e?i.addClass("red"):i.hasClass("red")&&i.removeClass("red"),a.val(a.val().substring(0,e)),i.text(a.val().length),i.removeClass("red")}function G(){le=$(".f-form-view-bg"),fe=$(".f-form-item-list");var t=fe.height()-le.height()+100;le.scrollTop(t)}function Q(){ce=$(".f-form-setting"),a.selectAction(ce,tt)}function R(){var t=$(".f-option-opt");a.selectAction(t)}function U(t){var e=t.closest(".f-form-item"),a={};ce=$(".f-form-setting"),fe=$(".f-form-item-list"),$('[current="true"]',fe).removeAttr("current"),t.closest(".f-form-item").attr("current","true"),ce.empty(),("id_checkbox"==e.attr("data-name")||"id_radio"==e.attr("data-name"))&&(a.value=[],$.each($('[data-type="list"]',e).find("label"),function(t,e){a.value.push({name:$(e).find("span").text(),img:$(e).find("img").attr("src")})})),"id_dropdown"==e.attr("data-name")&&(a["default"]=$(".f-select",e).find("em").text(),a.value=[],$.each($('[data-type="select"]',e).find("li"),function(t,e){a.value.push({name:$(e).text()})})),"id_text"==e.attr("data-name")&&(a.type=e.find("input").attr("type")),"id_picture"==e.attr("data-name")&&(a.url=e.find("a").attr("href"),a.img=e.find("img").attr("src"),a.descriptions=e.find("span").text()),"id_image"==e.attr("data-name")&&(a.img=e.find("img").attr("src"),a.description=e.find(".f-description").find("span").text(),a.value=e.find("img").attr("src")),a.title=e.find("h2").find("em").text(),a.required=e.find("h2").find("span")[0]?1:0,a.name=e.attr("data-name"),a.placeholder="默认文本";var i={data:a};return i}function V(){ce=$(".f-form-setting"),fe=$(".f-form-item-list"),fe.on("click",'[data-name="id_text"]',function(){var t=$(this);ce.append(Lt(U(t).data))}).on("click",'[data-name="id_textarea"]',function(){var t=$(this);ce.append(Lt(U(t).data)),$("#f_text_type",ce).hide()}).on("click",'[data-name="id_dropdown"]',function(){var t=$(this);ce.append(Ft(U(t).data))}).on("click",'[data-name="id_radio"]',function(){var t=$(this);ce.append(jt(U(t).data))}).on("click",'[data-name="id_checkbox"]',function(){var t=$(this);ce.append(jt(U(t).data))}).on("click",'[data-name="id_section"]',function(){var t=$(this);ce.append(Yt(U(t).data))}).on("click",'[data-name="id_image"]',function(){var t=$(this);ce.append(Gt(U(t).data))}).on("click",'[data-name="id_picture"]',function(){var t=$(this);ce.append(Qt(U(t).data))}).on("click",".f-item-del",function(){var t=$(this);return $('[data-type="curr"]',fe).removeAttr("data-type"),t.closest(".f-form-item").remove(),ce.empty(),!1})}function X(){ce=$(".f-form-setting"),fe=$(".f-form-item-list");var t={},e=$('[data-name="title"]').val(),a=$("[option-name]",ce).attr("option-name");e?t.title=e:t.title=$('[data-name="title"]').attr("placeholder"),t.required=$("[data-required]",ce).attr("data-required"),t.name=a,t.placeholder="默认文本",("id_checkbox"==a||"id_radio"==a)&&(t.value=[],$.each($(".f-setting-option",ce).find('[data-name="option"]'),function(e,a){var i=$(a).closest(".f-setting-option").find("img").attr("src");$(a).val()?t.value.push({name:$(a).val(),img:i}):t.value.push({name:$(a).attr("placeholder"),img:i})})),"id_dropdown"==a&&(t.value=[],$.each($(".f-setting-option",ce).find('[data-name="option"]'),function(e,a){$(a).val()?t.value.push({name:$(a).val()}):t.value.push({name:$(a).attr("placeholder")})}),t["default"]=t.value[0].name),"id_text"==a&&(t.type=$("[text-type]",ce).attr("text-type")),"id_picture"==a&&(t.descriptions=$(".f-textarea",ce).val(),t.img=$("img",ce).attr("src"),t.url=$('[data-name="url"]',ce).val()),"id_image"==a&&(t.description=$('[data-name="description"]').val(),t.img=$("img",ce).attr("src"),t.value=$("img",ce).attr("src"));var i={data:t};return i}function tt(){ce=$(".f-form-setting"),fe=$(".f-form-item-list");var t,e=$("[option-name]",ce).attr("option-name");"id_checkbox"==e&&(t=$('[current="true"]',fe),t.replaceWith(Mt(X().data))),"id_section"==e&&(t=$('[current="true"]',fe),t.replaceWith(Dt(X().data))),"id_text"==e&&(t=$('[current="true"]',fe),t.replaceWith(Tt(X().data))),"id_radio"==e&&(t=$('[current="true"]',fe),t.replaceWith(Ht(X().data))),"id_dropdown"==e&&(t=$('[current="true"]',fe),t.replaceWith(Jt(X().data))),"id_textarea"==e&&(t=$('[current="true"]',fe),t.replaceWith(Ot(X().data))),"id_image"==e&&(t=$('[current="true"]',fe),t.replaceWith(Pt(X().data))),"id_picture"==e&&(t=$('[current="true"]',fe),t.replaceWith(Bt(X().data)))}function et(){var t="<div class=f-form-view-mask></div>";ce=$(".f-form-setting"),le=$(".f-form-view-bg"),ce.on("keyup focusout",'[type="text"]',function(){tt(),"title"==$(this).attr("data-name")?E(this,25):"option"==$(this).attr("data-name")?E(this,20):("description"==$(this).attr("data-name")||"descriptions"==$(this).attr("data-name"))&&E(this,100),pe=!1}).on("focusin",'[type="text"]',function(){le.append(t)}).on("focusout",'[type="text"]',function(){tt(),$(".f-form-view-mask")&&$(".f-form-view-mask").remove()}),ce.on("click",'[data-action="del-item"]',function(){var t=$(this);$(".f-setting-option",ce).length>1?(t.closest(".f-setting-option").remove(),tt()):alert("最少需要有一个选项"),pe=!1}).on("click",'[data-action="add-item"]',function(){var t=$(this),e={};if($(".f-setting-option",ce).length<10){var a=t.closest(".f-control-group");t.closest(".f-control-group").hasClass("f-control-group-select")?(e.img=!1,a.append(Zt(e))):(e.img=!0,a.append(Zt(e))),tt()}else alert("最多不可以超过10个选项");pe=!1}).on("change",'[data-action="add-pic"]',function(){pt(this),pe=!1}).on("click",'[data-action="del-pic"]',function(){ut(this),pe=!1}).on("change",'[data-action="add-picture"]',function(){mt(this),pe=!1}).on("click",'[data-action="del-picture"]',function(){ht(this),pe=!1}).on("click",'[option-name="id_text"]',function(){$("#f_text_type").show(),pe=!1}).on("click",'[option-name="id_textarea"]',function(){$("#f_text_type").hide(),pe=!1})}function at(){var t,e,a=$(".f-title",$(".f-body-wrap")),i=$(".f-header",$(".f-header-opt")),n=$(".f-input",i),r=$(".f-textarea",i);i.on("focusout",".f-input",function(){var e=a.find("h1").text();t=n.val(),""==t?a.find("h1").text("请输入表单标题"):(a.find("h1").text(t),e!=t&&(pe=!1))}).on("focusout",".f-textarea",function(){var t=a.find("p").text();e=r.val(),""==e?a.find("p").text("请输入表单副标题"):a.find("p").text(e),t!=e&&(pe=!1)})}function it(t,e,a){return t.id=e,t.title=$(a).find("h2").find("em").text(),t.instruct="",$(a).find("h2").find("span")[0]?t.required=!0:t.required=!1,t}function nt(t,e){var a=$(t).find("label");return $.each(a,function(t,a){var i={};i.lid=t,i.name=$(a).find("span").text(),i.img=$(a).find("em img").attr("src"),i.selected=!1,e.push(i)}),e}function rt(){var t={},e=[],a=[];fe=$(".f-form-item-list"),le=$(".f-form-view-bg");var i=$(".f-title",le),n=$(".f-form-item",fe);$.each(n,function(t,i){var n,r=$(i).attr("data-name"),o=!1;if($(i).find("img").length>0&&(o=!0),"id_checkbox"==r&&(a=[],n={},o?n.name="id_image_checkbox":n.name="id_checkbox",it(n,t,i),nt(i,a),n.value=a),"id_radio"==r&&(a=[],n={},o?n.name="id_image_radio":n.name="id_radio",it(n,t,i),nt(i,a),n.value=a),"id_section"==r&&(n={},n.name="id_section",n.id=t,n.title=$(i).find("h2").find("em").text()),"id_text"==r&&(n={},n.name="id_text",n.type=$(i).find("input").attr("type"),it(n,t,i)),"id_dropdown"==r){a=[],n={},n.name="id_dropdown",it(n,t,i);var d=$(i).find("li"),s=[];$.each(d,function(t,e){var a={};a.lid=t,a.name=$(e).text(),0==t?a.selected=!1:a.selected=!1,s.push(a)}),n.value=s}"id_textarea"==r&&(n={},n.name="id_textarea",it(n,t,i)),"id_image"==r&&(n={},n.name="id_image",it(n,t,i),n.description=$(i).find(".f-description").find("span").text(),n.img=$(i).find("img").attr("src"),n.value=$(i).find("img").attr("src")),"id_picture"==r&&(n={},n.name="id_picture",n.id=t,n.url=$(i).find("a").attr("href"),n.descriptions=$(i).find("span").text(),n.img=$(i).find("img").attr("src")),e.push(n)}),t.title=i.find("h1").text(),t.subtitle=i.find("p").text(),"请输入表单副标题"==t.subtitle&&(t.subtitle=""),t.title_visible=!0,t.published=!1,t.fields=e;var r,o,d=$("#f_select_opt").find("em").attr("data-type");"select-doc"==d?(o=$("#f_selectdoc").find(".f-input").attr("data-docId"),o?t.after_submit={type:"post_id",value:o}:(r=$("#f_selectpage").find("em").attr("page-id"),t.after_submit={type:"page_id",value:r})):(r=$("#f_selectpage").find("em").attr("page-id"),t.after_submit={type:"page_id",value:r}),me.attr("surveyId")&&(t.id=me.attr("surveyId"));var s=JSON.stringify(t);return s}function ot(){var t=rt();e.creatSurveys(he,t,function(t){O(),me.attr("surveyId",t.data.id),pe=!0},function(){})}function dt(){var t,a=rt();t=me.attr("surveyId")?me.attr("surveyId"):0;var i={};""==$("#form_title_ipt").find("input").val()?alert("您还没有填写表单的名称"):$(".f-form-item-list").find(".f-form-item").length<=0?alert("您还没有添加任何一项表单内容"):e.publish(t,he,a,function(t){i=t.data,i.siteId=he,O(),me.empty(),me.append(te(i)),st(t.data),pe=!0},function(){})}function st(t){ct(),ft(t)}function ct(){$("#f-copy-url").zclip({path:"/pf/survey/appsrc/js/plugins/ZeroClipboard.swf",copy:function(){return $(this).prev().val()}})}function ft(t){var e={};e.title="大家好，这是我的"+t.title+"（调查问卷），欢迎大家填写。",e.pic=$("#f_qrcode").attr("src"),e.url=$(".f-complate-input").val(),$(".f-complete-wrap").on("click",".f-outside-wb",function(){n.shareTo("weibo",e)}).on("click",".f-outside-rr",function(){n.shareTo("renren",e)}).on("click",".f-outside-qz",function(){n.shareTo("qq",e)}).on("click",".f-outside-db",function(){n.shareTo("douban",e)}).on("click",".f-outside-qwb",function(){n.shareTo("qwb",e)})}function lt(){var t=$(".f-form-item-list");t.sortable({revert:!0,axis:"y",distance:20,opacity:.4,cursor:"move",scroll:!0,scrollSensitivity:40,items:".f-form-item",placeholder:"f-form-placeholder"})}function pt(t){var a=new FormData,i=$(t).closest(".f-setting-option").find('[type="text"]').val();a.append("image",t.files[0]),e.uploadPic(he,a,function(e){var a={};a.img=e.data,a.text=i,$(t).closest(".f-setting-option").replaceWith(Kt(a)),tt()},function(){alert("文件超过5M或者格式有误，请重新选择图片！")},{processData:!1,contentType:!1})}function ut(t){var e=$(t).offset(),a=$(t).closest(".f-setting-option").find('[type="text"]').val();i.show({msg:"确定要删除吗?",top:e.top,left:e.left,confirmWidth:"200px"},function(){var e={};e.img=!0,e.text=a,$(t).closest(".f-setting-option").replaceWith(Zt(e)),tt()})}function mt(t){var a=new FormData,i=$(t).closest(".f-setting-option").find('[type="text"]').val();a.append("image",t.files[0]),e.uploadPic(he,a,function(e){var a={};a.img=e.data,a.text=i,$(t).closest(".f-setting-option").replaceWith(Rt(a)),tt()},function(){alert("文件超过5M或者格式有误，请重新选择图片！")},{processData:!1,contentType:!1})}function ht(t){var e=$(t).offset(),a=$(t).closest(".f-setting-option").find('[type="text"]').val();i.show({msg:"确定要删除吗?",top:e.top,left:e.left,confirmWidth:"200px"},function(){var e={};e.img=!0,e.text=a,$(t).closest(".f-setting-option").replaceWith(Ut(e)),tt()})}function $t(){ue.on("click",'[data-action="del-survey"]',function(){var t=$(this).closest("dd").attr("data-id"),a={},n=$(this).offset();i.show({msg:"确定要删除吗?",top:n.top,left:n.left,confirmWidth:"200px"},function(){e.delSurvey(t,he,a,function(){O(),A()})})}).on("click",'[data-action="show-survey"]',function(){var t=$(this),e=$(this).offset(),a=t.closest("dd").attr("data-id");pe?$.getJSON("/pa/survey/forms/"+a+"?site_id="+he,function(e){me.attr("surveyId",e.data.id),me.empty(),A(e.data,function(){se=$(".f-add-section",me),se.before(At(e.data.fields))}),ue.find(".curr").removeClass("curr"),t.closest("dd").addClass("curr")}):i.show({msg:"未保存的数据将会丢失，确认要离开吗？",top:e.top,left:e.left+130,InnerYesBtn:"确认离开",InnerNoBtn:"留在此页",confirmWidth:"270px"},function(){$.getJSON("/pa/survey/forms/"+a+"?site_id="+he,function(e){me.attr("surveyId",e.data.id),me.empty(),A(e.data,function(){se=$(".f-add-section",me),se.before(At(e.data.fields))}),ue.find(".curr").removeClass("curr"),t.closest("dd").addClass("curr"),pe=!0})})}).on("click",'[data-action="creat-form"]',function(){var t=$(this).offset();pe?(A(),me.removeAttr("surveyid")):i.show({msg:"未保存的数据将会丢失，要保存草稿吗？",top:t.top,left:t.left+130,InnerYesBtn:"确认离开",InnerNoBtn:"留在此页",confirmWidth:"270px"},function(){A(),me.removeAttr("surveyid"),pe=!0})}).on("click",'[data-action="survey-stat"]',function(){var t=$(this),e=$(this).offset(),a=t.closest("dd").attr("data-id"),n=yt(Math.round(t.closest("dd").attr("data-date")),"yyyy-MM-dd HH:mm"),r=t.text();pe?(vt(a,{page_size:12,order:"desc",range:"1",date:n,title:r},"all"),ue.find(".curr").removeClass("curr"),$(this).closest("dd").addClass("curr")):i.show({msg:"未保存的数据将会丢失，要保存草稿吗？",top:e.top,left:e.left+130,InnerYesBtn:"确认离开",InnerNoBtn:"留在此页",confirmWidth:"270px"},function(){vt(a,{page_size:12,order:"desc",range:"1",date:n,title:r},"all"),ue.find(".curr").removeClass("curr"),$(this).closest("dd").addClass("curr"),pe=!0})})}function vt(t,e,a){$.getJSON("/pa/survey/surveys/"+t+"/answers?site_id="+he,e,function(i){"desc"==e.order?(i.data.sort=!0,i.data.reverse=!1):(i.data.sort=!1,i.data.reverse=!0),i.data.other=a,i.data.range=e.range,i.data.date=e.date,i.data.title=e.title,$.each(i.data.dataList,function(t,e){e.date=yt(e.created_at,"yyyy-MM-dd HH:mm")}),gt(i.data,t,e,a)})}function gt(t,e,a,i){me.empty(),me.append(Xt(t)),me.attr("surveyId",e);var n=$(".f-model-list");n.empty(),n.append(ie(t)),_t(t,a,i),wt(e,a);var r=$(".f-model-show");$.getJSON("/pa/survey/forms/"+e+"?site_id="+he,function(t){t.data.showTitle=!0,r.empty(),r.append(ae(t.data))})}function _t(t,e,a){var i=me.attr("surveyid"),n=$(".f-model-paging");St(n,t),n.on("click",'[data-action="gotopage"]',function(){var t=$(this).attr("data-page");e.page_no=t,$.getJSON("/pa/survey/surveys/"+i+"/answers?site_id="+he,e,function(t){e.order?(t.data.sort=!0,t.data.reverse=!1):(t.data.sort=!1,t.data.reverse=!0),t.data.date=e.date,t.data.other=a,$.each(t.data.dataList,function(t,e){e.date=yt(e.created_at,"yyyy-MM-dd HH:mm")}),gt(t.data,i,e)})})}function xt(t,e){var a,i=$(t).closest(".f-model-edit").find(".f-btn").attr("data-action");a="reverse"==i?"asc":"desc";var n=$(t),r=me.attr("surveyId"),o=n.attr("select-type");"all"==o&&vt(r,{page_size:12,order:a,date:e.date},"all"),"star"==o&&vt(r,{page_size:12,star:!0,order:a,date:e.date},"star"),"done"==o&&vt(r,{page_size:12,done:!1,order:a,date:e.date},"done"),"unread"==o&&vt(r,{page_size:12,unread:!0,order:a,date:e.date},"unread")}function yt(t,e){var a=new Date(t),i=function(t){return(10>t?"0":"")+t};return e.replace(/yyyy|MM|dd|HH|mm|ss/g,function(t){switch(t){case"yyyy":return i(a.getFullYear());case"MM":return i(a.getMonth()+1);case"mm":return i(a.getMinutes());case"dd":return i(a.getDate());case"HH":return i(a.getHours());case"ss":return i(a.getSeconds())}})}function wt(t,a){var n=$(".f-view-wrap"),t=t,r=$(".f-model-tab");r.on("click","[select-type]",function(){xt(this,a)}),n.on("click",'[data-action="show-answer"]',function(){var a=$(".f-model-show"),i=$(this).attr("data-id"),n=$(this);$.getJSON("/pa/survey/surveys/"+t+"/answers/"+i+"?site_id="+he,function(r){a.empty(),a.append(ae(r.data));var o={unread:!1};n.find(".f-doc").length&&e.setStatus(t,he,i,o,"read",function(){n.find(".f-doc").remove()}),$(".f-model-list").find(".curr").removeClass("curr"),n.addClass("curr")})}).on("click",'[data-action="getstar"]',function(){var a=$(this),i=$(".f-show-con").attr("data-id"),n=$(".f-show-con").attr("data-star"),r={};"true"==n?(r={star:!1},e.setStatus(t,he,i,r,"star",function(){$(".f-model-list").find(".curr").find(".f-star").find("i").remove(),$(".f-show-con").attr("data-star","false"),a.find("span").text("星标")})):(r={star:!0},e.setStatus(t,he,i,r,"star",function(){$(".f-model-list").find(".curr").find(".f-star").append('<i class="iconfont">&#xe610;</i>'),$(".f-show-con").attr("data-star","true"),a.find("span").text("取消星标")}))}).on("click",'[data-action="done"]',function(){var a=$(this),i=$(".f-show-con").attr("data-id"),n=$(".f-show-con").attr("data-done"),r={};"true"==n?(r={done:!1},e.setStatus(t,he,i,r,"done",function(){$(".f-model-list").find(".curr").find(".f-selected").find("i").remove(),$(".f-show-con").attr("data-done","false"),a.find("span").text("处理")})):(r={done:!0},e.setStatus(t,he,i,r,"done",function(){$(".f-model-list").find(".curr").find(".f-selected").append('<i class="iconfont">&#xe612;</i>'),$(".f-show-con").attr("data-done","true"),a.find("span").text("取消处理")}))}).on("click",'[data-action="delete"]',function(){var a=$(".f-show-con").attr("data-id"),n={},r=$(this).offset(),o=$(".f-model-show");i.show({msg:"数据删除不可恢复，是否确认?",top:r.top,left:r.left,confirmWidth:"250px"},function(){e.deleteAnswer(t,he,a,n,function(){$(".f-model-list").find(".curr").remove(),o.find(".f-show-con").empty()})})}).on("click",'[data-action="reverse"]',function(){var e=$(this).closest(".f-model-edit").find(".curr").attr("select-type");"star"==e?vt(t,{page_size:12,order:"desc",star:!0,date:a.date},e):"done"==e?vt(t,{page_size:12,order:"desc",done:!1,date:a.date},e):"unread"==e?vt(t,{page_size:12,order:"desc",unread:!0,date:a.date},e):vt(t,{page_size:12,order:"desc",date:a.date})}).on("click",'[data-action="sort"]',function(){var e=$(this).closest(".f-model-edit").find(".curr").attr("select-type");"star"==e?vt(t,{page_size:12,star:!0,date:a.date},e):"done"==e?vt(t,{page_size:12,done:!1,date:a.date},e):"unread"==e?vt(t,{page_size:12,unread:!0,date:a.date},e):vt(t,{page_size:12,date:a.date})}).on("click",'[data-action="export"]',function(){window.open("/pa/survey/surveys/"+t+"/answers/0/export?site_id="+he)}).on("click",'[data-action="open-share"]',function(){var e={};e.surveyId=t,e.siteId=he,e.title=$(".f-side").find(".curr").find("span").text(),me.append(ne(e)),kt(e)});var o=$(".f-view-tab"),d=$('[page-id="answer"]'),s=$('[page-id="table"]');o.on("click",'[data-action="show-answer-page"]',function(){o.find(".curr").removeClass("curr"),$(this).closest("li").addClass("curr"),s.hide(),d.show()}).on("click",'[data-action="show-table-page"]',function(){var t=ue.find(".curr").attr("data-id"),e=$(this);$.getJSON("/pa/survey/surveys/"+t+"/stat?site_id="+he,function(t){o.find(".curr").removeClass("curr"),e.closest("li").addClass("curr"),d.hide(),s.show(),s.empty(),$.each(t.data.fields,function(t,e){var a=0;e.value&&$.each(e.value,function(t,e){a+=e.selected_count}),e.valCount=Math.floor(a)}),bt(t.data)})}),s.on("click",'[data-action="show-text"]',function(){Ct(this)})}function kt(t){var e=$(".f-share-dlg"),a={};a.title="大家好，这是我的"+t.title+"（调查问卷），欢迎大家填写。",a.pic="http://form.kuaizhan.com/forms/"+t.surveyId+"/qrcode",a.url="http://form.kuaizhan.com/forms/"+t.surveyId,e.on("click",".f-outside-wb",function(){n.shareTo("weibo",a)}).on("click",".f-outside-rr",function(){n.shareTo("renren",a)}).on("click",".f-outside-qz",function(){n.shareTo("qq",a)}).on("click",".f-outside-db",function(){n.shareTo("douban",a)}).on("click",".f-outside-qwb",function(){n.shareTo("qwb",a)}),$("#share_dlg_clip").zclip({path:"/pf/survey/appsrc/js/plugins/ZeroClipboard.swf",copy:function(){return $(this).prev().text()}}),$('[data-action="close-modal"]').on("click",function(){$(".f-modal",$(".f-p-wrap")).remove(),$(".f-modal-mask").remove(),$("html").css({overflow:"auto"})})}function bt(t){var e=[],a=[],i=$.extend({},t.visits,t.answerCount),n=[];$.each(i,function(t,e){n.push(t)}),n.sort();var r=n.pop();r=r.replace(/-/g,"/");for(var o=new Date(r),d=[],s=new Date(o.setDate(o.getDate()-30)),c=0;30>c;c++){var f=new Date(s.setDate(s.getDate()+1)),l=f.getDate(),p=f.getMonth()+1,u=f.getFullYear();10>p&&(p="0"+p),10>l&&(l="0"+l);var m=u+"-"+p+"-"+l;d.push(m)}var h={},v=[];$.each(d,function(t,e){h[e]=0,v.push(e)});var g=$.extend({},h,t.answerCount),_=$.extend({},h,t.visits);$.each(g,function(t,e){a.push(e)}),$.each(_,function(t,a){e.push(a)});var x=[];$.each(v,function(t,e){var a=e.substring(5);x.push(a)}),e=e.slice(0,30),a=a.slice(0,30);var y=$('[page-id="table"]');y.append(oe(t));var w=$("#answerCanvas");w.highcharts({title:{text:t.title},subtitle:{text:""},xAxis:{categories:x},yAxis:{title:{text:""},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{valueSuffix:""},legend:{layout:"horizontal",align:"top",x:560,y:-130,verticalAlign:"middle",borderWidth:0},series:[{name:"反馈数量",data:a},{name:"浏览数量",data:e}]});var k=$($(".highcharts-axis-labels")[0]),b=k.find("text");$.each(b,function(t,e){(t+1)%5&&0!=t&&30!=t?$(e).remove():$(e).attr("y",272)})}function Ct(t){var e=me.attr("surveyId"),a=$(t).attr("data-lid");$.getJSON("/pa/survey/surveys/"+e+"/fields/"+a+"?site_id="+he,{page_size:9,page_no:1},function(t){$(".f-p-wrap").append(re(t.data)),zt(t.data,e,a),$("html").css({overflow:"hidden"})})}function zt(t,e,a){var i=$(".f-answers-paging");St(i,t),i.on("click",'[data-action="gotopage"]',function(){var t=$(this).attr("data-page");$.getJSON("/pa/survey/surveys/"+e+"/fields/"+a+"?site_id="+he,{page_size:9,page_no:t},function(t){$(".f-modal").remove(),$(".f-modal-mask").remove(),$(".f-p-wrap").append(re(t.data)),zt(t.data,e,a)})}),$('[data-action="close-modal"]').on("click",function(){$(".f-modal",$(".f-p-wrap")).remove(),$(".f-modal-mask").remove(),$("html").css({overflow:"auto"})})}function It(){$(".f-p-wrap").on("click",'[data-action="remove-modal"]',function(){$(".f-modal",$(".f-p-wrap")).remove(),$(this).remove(),$("html").css({overflow:"auto"})})}function St(t,e){var a=e.totalPageCount;if(!(a>1))return!1;var i,n=e.currentPageNo,r=(e.currentPageSize,{});r.noNext=!1,r.noPre=!1,r.more=!1,r.currentPage=!1,r.max=e.totalPageCount;var o=0,d=0;5>=a?(i=[],o=1,d=a):(i=[],4>=n?(o=1,d=5):n>=a-3?(o=a-4,d=a):(o=n-2,d=n+2));for(var s=o;d>=s;s++)i.push({currentPage:n==s?!0:!1,num:s});r.first=1,r.last=a,r.next=n+1,r.next>a&&(r.noNext=!0,r.next="unclick"),r.pre=n-1,r.pre<1&&(r.pre="unclick",r.noPre=!0),r.pages=i,t.empty(),t.append(de(r))}function qt(){$(window).bind("beforeunload",function(){return 0==pe?"确认离开本页？未保存的内容将会丢失!":void 0})}function Nt(){J()}function Wt(){return $e}var Mt,Tt,Dt,Ht,Jt,Ot,At,Pt,Bt,jt,Yt,Ft,Lt,Zt,Kt,Et,Gt,Qt,Rt,Ut,Vt,Xt,te,ee,ae,ie,ne,re,oe,de,se,ce,fe,le,pe=!0,ue=$(".f-side"),me=$(".f-con"),he=$(".f-con").attr("siteId"),$e={preload:Wt,show:Nt};return $e});